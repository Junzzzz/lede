#
# This is free software, lisence use MIT.
# 
# Copyright (C) 2019 KFERMercer KFER.Mercer@gmail.com
# 
# httpsgithub.comKFERMercerOpenWrt-CI
#

name Merge-upstream

on
  push
    branches 
      - master
  schedule
    - cron 30 19   

jobs
  merge

    runs-on ubuntu-latest

    steps

    - name Checkout
      uses actionscheckout@master
      with
        ref master
        fetch-depth 0
        lfs true

    - name Set git identity
      run  
        git config --global user.email 41898282+github-actions[bot]@users.noreply.github.com
        git config --global user.name github-actions[bot]
    - name Load upstream commits
      run git pull httpsgithub.comcoolsnowwolflede.git --log --no-commit

    - name Apply commit changes
      run 
        if [ -f ..gitMERGE_MSG ]; then
        mkdir .tmp && cp ..gitMERGE_MSG .tmpmessage
        sed -i 1c [bot] AutoMerging merge all upstream's changes .tmpmessage
        sed -i '^#.d' .tmpmessage
        git commit --file=.tmpmessage
        else
        echo There is no merge commits.
        fi
    - name Push Commits
      env
        DOWNSTREAM_BRANCH master
      run git push origin $DOWNSTREAM_BRANCH